{% extends "base.html" %}

{% block title %}{{ car.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            {% if car.image_url %}
            <img src="{{ url_for('static', filename=car.image_url) }}" class="card-img-top" alt="{{ car.title }}" style="max-height: 400px; object-fit: contain;">
            {% else %}
            <img src="{{ url_for('static', filename='images/default-car.jpg') }}" class="card-img-top" alt="Default car image" style="max-height: 400px; object-fit: contain;">
            {% endif %}
            <div class="card-body">
                <h1 class="card-title">{{ car.title }}</h1>
                <p class="car-price display-4">${{ "%.2f"|format(car.price) }}</p>
                
                <div class="car-details mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Make:</strong> {{ car.make }}</p>
                            <p><strong>Model:</strong> {{ car.model }}</p>
                            <p><strong>Year:</strong> {{ car.year }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Mileage:</strong> {{ car.mileage }} miles</p>
                            <p><strong>Category:</strong> {{ car.category.name }}</p>
                            <p><strong>Listed by:</strong> {{ car.owner.username }}</p>
                        </div>
                    </div>
                </div>

                <h4>Description</h4>
                <p class="card-text">{{ car.description }}</p>

                {% if current_user.is_authenticated and current_user.id != car.owner_id %}
                <div class="d-grid gap-2 mb-3">
                    <a href="{{ url_for('cars.request_trade', car_id=car.id) }}" class="btn btn-primary">
                        <i class="bi bi-arrow-left-right"></i> Request Trade
                    </a>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#inquiryModal">
                        <i class="bi bi-envelope"></i> Send Inquiry
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Comments Section -->
        <div class="card">
            <div class="card-body">
                <h4>Comments</h4>
                {% if current_user.is_authenticated and current_user.id != car.owner_id %}
                <form method="POST" action="{{ url_for('cars.add_comment', car_id=car.id) }}" class="mb-4">
                    <div class="mb-3">
                        <label for="rating" class="form-label">Rating</label>
                        <select class="form-select" id="rating" name="rating" required>
                            <option value="">Select rating</option>
                            <option value="5">★★★★★ (5)</option>
                            <option value="4">★★★★☆ (4)</option>
                            <option value="3">★★★☆☆ (3)</option>
                            <option value="2">★★☆☆☆ (2)</option>
                            <option value="1">★☆☆☆☆ (1)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="comment" class="form-label">Your Comment</label>
                        <textarea class="form-control" id="comment" name="comment" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Comment</button>
                </form>
                {% endif %}

                {% if comments %}
                <div class="comments-list">
                    {% for comment in comments %}
                    <div class="comment card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h6 class="card-subtitle mb-2 text-muted">{{ comment.user.username }}</h6>
                                <div class="rating">
                                    {% for i in range(comment.rating) %}★{% endfor %}
                                    {% for i in range(5 - comment.rating) %}☆{% endfor %}
                                </div>
                            </div>
                            <p class="card-text">{{ comment.comment }}</p>
                            <small class="text-muted">{{ comment.created_at.strftime('%B %d, %Y') }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No comments yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-body">
                <h4>Contact Information</h4>
                <p><i class="bi bi-person"></i> {{ car.owner.username }}</p>
                <p><i class="bi bi-envelope"></i> {{ car.owner.email }}</p>
                {% if current_user.is_authenticated and current_user.id != car.owner_id %}
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#inquiryModal">
                    <i class="bi bi-envelope"></i> Send Inquiry
                </button>
                {% endif %}
            </div>
        </div>

        {% if current_user.is_authenticated and current_user.id == car.owner_id %}
        <div class="card">
            <div class="card-body">
                <h4>Listing Management</h4>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('cars.edit_car', car_id=car.id) }}" class="btn btn-primary">
                        <i class="bi bi-pencil"></i> Edit Listing
                    </a>
                    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="bi bi-trash"></i> Delete Listing
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Inquiry Modal -->
{% if current_user.is_authenticated and current_user.id != car.owner_id %}
<div class="modal fade" id="inquiryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('cars.send_inquiry', car_id=car.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Send Inquiry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="message" class="form-label">Your Message</label>
                        <textarea class="form-control" id="message" name="message" rows="4" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Inquiry</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Delete Modal -->
{% if current_user.is_authenticated and current_user.id == car.owner_id %}
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this listing? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="{{ url_for('cars.delete_car', car_id=car.id) }}" class="btn btn-danger">Delete</a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %} 